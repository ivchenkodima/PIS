<!DOCTYPE html>

<html>
<head>
  <title>app.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>app.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
<span class="hljs-pi">    'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A cross-browser requestAnimationFrame
See <a href="https://hacks.mozilla.org/2011/08/animating-with-javascript-from-setinterval-to-requestanimationframe/">link</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> requestAnimFrame = (<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.requestAnimationFrame       ||
            <span class="hljs-built_in">window</span>.webkitRequestAnimationFrame ||
            <span class="hljs-built_in">window</span>.mozRequestAnimationFrame    ||
            <span class="hljs-built_in">window</span>.oRequestAnimationFrame      ||
            <span class="hljs-built_in">window</span>.msRequestAnimationFrame     ||
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)</span>{
                <span class="hljs-built_in">window</span>.setTimeout(callback, <span class="hljs-number">1000</span> / <span class="hljs-number">60</span>);
            };
    })();</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Generate random number from min to max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRandomInt</span>(<span class="hljs-params">min, max</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * (max - min + <span class="hljs-number">1</span>)) + min;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="canvas-element">Canvas element</h2>
<p>Game container element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> container = <span class="hljs-built_in">document</span>.querySelector(<span class="hljs-string">'#game'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Create new canvas element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> canvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'canvas'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Get 2D graphic context from canvas.
Canvas provides methods for drawing shapes and manipulating with them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ctx = canvas.getContext(<span class="hljs-string">'2d'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Score element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> $gameScore = container.querySelector(<span class="hljs-string">'.game__score'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Appending canvas to container element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    container.appendChild(canvas);

    canvas.width = <span class="hljs-number">600</span>;
    canvas.height = <span class="hljs-number">400</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="resize">Resize</h2>
<p>Callback on resizing event. We make canvas element full-screen size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resize</span>(<span class="hljs-params"></span>) </span>{
        canvas.width = <span class="hljs-built_in">window</span>.innerWidth;
        canvas.height = <span class="hljs-built_in">window</span>.innerHeight;
    }
    <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'resize'</span>, resize, <span class="hljs-literal">false</span>); resize();</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="resources">Resources</h2>
<p>We load resources for the app using simple library <a href="./resources.html">resources.js</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resources.load([
        <span class="hljs-string">'img/brickwall.png'</span>
    ]);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Waiting of ready event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resources.onReady(init);


    <span class="hljs-keyword">var</span> lstTime = <span class="hljs-literal">null</span>,
        now;

    <span class="hljs-keyword">var</span> brickPattern = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="initializing">Initializing</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'init'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Setting background pattern variable</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        brickPattern = ctx.createPattern(resources.get(<span class="hljs-string">'img/brickwall.png'</span>), <span class="hljs-string">'repeat'</span>);

        reset();
        lstTime = <span class="hljs-built_in">Date</span>.now();
        main();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h2 id="game-loop">Game loop</h2>
<p>Game process include frame rendering one be one. So we neww the loop, which initialize re-render call.</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Main loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span> (<span class="hljs-params"></span>) </span>{
        now = <span class="hljs-built_in">Date</span>.now();
        <span class="hljs-keyword">var</span> dt = (now - lstTime) / <span class="hljs-number">1000.0</span>;

        update(dt);
        render(ctx);

        lstTime = now;
        requestAnimFrame(main);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reset</span> (<span class="hljs-params"></span>) </span>{
        tubes = [];
        player.y = <span class="hljs-number">300</span>;
        player.x = <span class="hljs-built_in">Math</span>.min(canvas.width * <span class="hljs-number">.30</span>, <span class="hljs-number">200</span>);
        <span class="hljs-built_in">console</span>.log(player.x);
        player.speed = <span class="hljs-number">0</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stopGame</span> (<span class="hljs-params"></span>) </span>{
        isGameOver = <span class="hljs-literal">true</span>;
        container.classList.add(<span class="hljs-string">'is-over'</span>);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">startGame</span> (<span class="hljs-params"></span>) </span>{
        isGameOver = <span class="hljs-literal">false</span>;
        container.classList.remove(<span class="hljs-string">'is-welcome'</span>);
        container.classList.remove(<span class="hljs-string">'is-over'</span>);
        score = <span class="hljs-number">0</span>;
        reset();
    }

    <span class="hljs-comment">/**
     * Game loops
     */</span>

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span> (<span class="hljs-params">ctx</span>) </span>{
        ctx.fillStyle = brickPattern;
        ctx.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.width,  canvas.height);

        player.render(ctx);
        renderTubes(ctx);
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderTubes</span> (<span class="hljs-params">ctx</span>) </span>{
        tubes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{
            renderTube(item, ctx);
        });
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">renderTube</span> (<span class="hljs-params">tube, ctx</span>) </span>{
        tube.render(ctx);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span> (<span class="hljs-params">dt</span>) </span>{

        <span class="hljs-keyword">if</span> (isGameOver) {
            <span class="hljs-keyword">return</span>;
        }
        player.update(dt);
        updateTubes(dt);
        checkCollisions();
        $gameScore.innerText = score;
    }

    <span class="hljs-keyword">var</span> totalDelay;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateTubes</span> (<span class="hljs-params">dt</span>) </span>{

        passedTubes = clearTubes (passedTubes);
        <span class="hljs-keyword">if</span> (totalDelay &lt; <span class="hljs-number">2</span>) {
            totalDelay += dt;
        } <span class="hljs-keyword">else</span> {
            addTube();
            totalDelay = <span class="hljs-number">0</span>;
        }
        (tubes || []).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{
            updateTube(item, dt);
        });
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateTube</span> (<span class="hljs-params">tube, dt</span>) </span>{
        tube.update(dt);
    }

    <span class="hljs-comment">/**
     * Inputs
     */</span>

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">action</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (isGameOver) {
            startGame ();
        }
        player.speedUp();
    }
    <span class="hljs-keyword">var</span> isTouchDevice = <span class="hljs-literal">true</span> == (<span class="hljs-string">"ontouchstart"</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">window</span> || <span class="hljs-built_in">window</span>.DocumentTouch &amp;&amp; <span class="hljs-built_in">document</span> <span class="hljs-keyword">instanceof</span> DocumentTouch);
    <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'keyup'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e, data</span>) </span>{
        <span class="hljs-keyword">if</span> (e.keyCode == <span class="hljs-number">32</span>) { <span class="hljs-comment">// space pressed</span>
            action ();
        }
    });
    <span class="hljs-keyword">if</span> (isTouchDevice) {
        <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'touchend'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e, data</span>) </span>{
            action();
        });
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">document</span>.addEventListener(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e, data</span>) </span>{
            action();
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isHaveCollisions</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (player.y &lt;= <span class="hljs-number">0</span> || player.y &gt;= canvas.height) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> isHaveCollisionsWithTubes (player);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isHaveCollisionsWithTubes</span> (<span class="hljs-params">player</span>) </span>{

        <span class="hljs-keyword">if</span> (!tubes[<span class="hljs-number">0</span>]) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (tubes[<span class="hljs-number">0</span>].checkCollisionWithPlayer (player)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> ((player.x - (tubes[<span class="hljs-number">0</span>].x + tubes[<span class="hljs-number">0</span>].width)) &gt; player.radius) {
            passedTubes.push(tubes.shift());
            score++;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkCollisions</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (isHaveCollisions()) {
            stopGame();
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'have collisions'</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearTubes</span> (<span class="hljs-params">tubes</span>) </span>{ <span class="hljs-comment">// clear invisible tubes</span>
        <span class="hljs-keyword">var</span> cur;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; tubes.length; i++) {
            cur = tubes[i];
            <span class="hljs-keyword">if</span> ((cur.x + cur.width + <span class="hljs-number">10</span>) &lt; <span class="hljs-number">0</span>) {
                tubes.shift();
                i--;

            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> tubes;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addTube</span> (<span class="hljs-params"></span>) </span>{
        tubes.push(<span class="hljs-keyword">new</span> Tube(<span class="hljs-number">50</span>, getRandomInt(<span class="hljs-number">50</span>, canvas.height - tubeApertureWidth / <span class="hljs-number">2</span> - <span class="hljs-number">50</span>), canvas.height, canvas.width, tubeApertureWidth));
    }

    <span class="hljs-keyword">var</span> isGameOver = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> tubes = [],
        passedTubes = [];
    <span class="hljs-keyword">var</span> score = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> player = <span class="hljs-keyword">new</span> Bird (canvas.height);

})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
